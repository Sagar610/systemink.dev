generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  EDITOR
  AUTHOR
}

enum PostStatus {
  DRAFT
  SCHEDULED
  PUBLISHED
}

enum CommentStatus {
  VISIBLE
  HIDDEN
}

model User {
  id           String    @id @default(cuid())
  name         String
  username     String    @unique
  email        String    @unique
  passwordHash String
  role         Role      @default(AUTHOR)
  bio          String?
  avatarUrl    String?
  links        Json      @default("{}")
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  posts          Post[]
  comments       Comment[]
  commentLikes   CommentLike[]
  sessions       Session[]
  passwordResets PasswordReset[]
  
  // Follow/Followers relationships
  following      Follow[] @relation("UserFollowing")
  followers      Follow[] @relation("UserFollowers")

  @@index([email])
  @@index([username])
}

model Follow {
  id          String   @id @default(cuid())
  followerId  String
  followingId String
  createdAt   DateTime @default(now())

  follower  User @relation("UserFollowing", fields: [followerId], references: [id], onDelete: Cascade)
  following User @relation("UserFollowers", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

model Post {
  id            String     @id @default(cuid())
  authorId      String
  title         String
  slug          String     @unique
  excerpt       String?
  contentMd     String
  contentHtml   String
  status        PostStatus @default(DRAFT)
  scheduledAt   DateTime?
  publishedAt   DateTime?
  coverImageUrl String?
  readingTime   Int        @default(1)
  viewsCount    Int        @default(0)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  author   User      @relation(fields: [authorId], references: [id], onDelete: Cascade)
  tags     PostTag[]
  comments Comment[]
  views    PostView[]

  @@index([slug])
  @@index([status, publishedAt])
  @@index([authorId])
}

model Tag {
  id    String @id @default(cuid())
  name  String
  slug  String @unique
  
  posts PostTag[]

  @@index([slug])
}

model PostTag {
  postId String
  tagId  String

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)
  tag  Tag  @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([postId, tagId])
  @@index([tagId])
}

model Comment {
  id        String        @id @default(cuid())
  postId    String
  userId    String
  parentId  String?
  body      String
  status    CommentStatus @default(VISIBLE)
  likesCount Int          @default(0)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent Comment? @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies Comment[] @relation("CommentReplies")
  likes CommentLike[]

  @@index([postId])
  @@index([userId])
  @@index([parentId])
}

model CommentLike {
  id        String   @id @default(cuid())
  commentId String
  userId    String
  createdAt DateTime @default(now())

  comment Comment @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([commentId, userId])
  @@index([commentId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  refreshToken String   @unique
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([refreshToken])
}

model PasswordReset {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
}

model PostView {
  id        String   @id @default(cuid())
  postId    String
  ipHash    String
  viewedAt  DateTime @default(now())

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId, viewedAt])
  @@index([postId, ipHash])
}
